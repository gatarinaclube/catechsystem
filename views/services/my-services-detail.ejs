<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Detalhe do Servi√ßo - CaTech</title>

    <!-- CSS GLOBAL -->
    <link rel="stylesheet" href="/css/theme.css" />
    <link rel="stylesheet" href="/css/layout.css" />
  </head>
  <body>
    <div class="shell">
      <%- include('../partials/sidebar', { user, currentPath }) %>

      <main class="main">
        <!-- HEADER PADR√ÉO -->
        <div class="header">
          <div>
            <div class="title-main">Detalhe do Servi√ßo</div>
            <div class="title-sub">
              C√≥digo: <strong><%= service.id %></strong>
              ¬∑ Tipo: <strong><%= service.type %></strong>
            </div>
          </div>

          <div class="header-actions">
            <a href="/my-services" class="btn">
              ‚Üê Voltar para Meus Servi√ßos
            </a>

            <a
              href="/my-services/<%= service.id %>/pdf"
              class="btn"
            >
              üìÑ Baixar comprovante (PDF)
            </a>

          </div>
        </div>

        <div class="content">
          <!-- BLOCO: INFORMA√á√ïES DO SERVI√áO -->
          <div class="section">
            <div class="section-title">Informa√ß√µes do servi√ßo</div>

            <div class="grid-2">
              <div class="field">
                <div class="field-label">Tipo de servi√ßo</div>
                <div class="field-value"><%= service.type %></div>
              </div>

              <div class="field">
                <div class="field-label">Data da solicita√ß√£o</div>
                <div class="field-value">
                  <%= new Date(service.createdAt).toLocaleString('pt-BR') %>
                </div>
              </div>
            </div>

            <div class="field">
              <div class="field-label">Descri√ß√£o</div>
              <div class="field-value">
                <%= service.description || "-" %>
              </div>
            </div>

<%
  // pega a pend√™ncia mais recente (se existir)
  const lastPending = (service.statuses || [])
    .filter(s => s.status === 'COM_PENDENCIA' && s.pendingNote)
    .slice(-1)[0];
%>

<% if (lastPending && lastPending.pendingNote) { %>
  <div class="field" style="margin-top:10px;">
    <div class="field-label">‚ö†Ô∏è Pend√™ncia</div>
    <div class="field-value" style="color:#dc2626; font-weight:600;">
      <%= lastPending.pendingNote %>
    </div>
    <div style="font-size:12px; color:#991b1b; margin-top:4px;">
      Registrado em <%= new Date(lastPending.createdAt).toLocaleString('pt-BR') %>
    </div>
  </div>
<% } %>



          </div>

          <!-- BLOCO: LINHA DO TEMPO DE STATUS -->
          <div class="section">
            <div class="section-title">Linha do tempo de status</div>

            <% 
              const mapStatus = {
                ENVIADO_GATARINA: "Enviado para Gatarina",
                COM_PENDENCIA: "Com Pend√™ncia",
                ENVIADO_FFB: "Enviado para FFB",
                RECEBIDO_FFB: "Recebido FFB",
                ENVIADO_ASSOCIADO: "Enviado para Associado",
              };
            %>

            <% if (!service.statuses || service.statuses.length === 0) { %>
              <p class="empty">
                Nenhum status adicional foi registrado al√©m da cria√ß√£o do servi√ßo.<br />
                <span style="font-size:12px;">
                  Solicitado em
                  <%= new Date(service.createdAt).toLocaleString('pt-BR') %>.
                </span>
              </p>
            <% } else { %>
              <ul class="list">
                <% service.statuses.forEach(function(st, index) { %>
                  <li class="item">
                    <div>
                      <div class="item-link" style="font-weight:600; text-decoration:none;">
                        <%= index + 1 %>. <%= mapStatus[st.status] || st.status %>
                      </div>


                      <div class="item-sub">
                        Registrado em
                        <%= new Date(st.createdAt).toLocaleString('pt-BR') %>
                      </div>

                      <% if (st.status === 'COM_PENDENCIA' && st.pendingNote) { %>
  <div class="item-sub" style="color:#dc2626; font-weight:600; margin-top:4px;">
    Pend√™ncia: <%= st.pendingNote %>
  </div>
<% } %>


                    </div>
                  </li>
                <% }) %>
              </ul>
            <% } %>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>

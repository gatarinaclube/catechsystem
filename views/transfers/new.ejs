<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Transfer√™ncia de Propriedade - CaTech</title>

    <!-- CSS GLOBAL -->
    <link rel="stylesheet" href="/css/theme.css" />
    <link rel="stylesheet" href="/css/layout.css" />
  </head>

  <body>
    <div class="shell">
      <!-- MENU PADR√ÉO -->
      <%- include('../partials/sidebar', { user, currentPath }) %>

      <!-- CONTE√öDO PRINCIPAL -->
      <main class="main">
        <div class="header">
          <div>
            <div class="title-main">Transfer√™ncia de Propriedade</div>
            <div class="title-sub">
              Preencha as informa√ß√µes da transfer√™ncia de propriedade do gato.
            </div>
          </div>

          <div class="header-actions">
            <a href="/services" class="btn">‚Üê Voltar aos servi√ßos</a>
          </div>
        </div>

        <!-- FORMUL√ÅRIO -->
        <form method="post" action="/transfers/new" enctype="multipart/form-data">
          <div class="content">

            <!-- SE√á√ÉO: DADOS DO GATO -->
            <div class="section">
              <div class="section-title"><strong>Dados do gato</strong></div>

              <div class="grid-2">
                <div class="field">
                  <label class="field-label" for="catId">Selecione o gato</label>
                  <select id="catId" name="catId" required>
                    <option value="">Selecione um gato...</option>

                    <% if (cats && cats.length) { %>
                      <% cats.forEach(function(c){ %>
                        <option 
                          value="<%= c.id %>"
                          data-name="<%= c.name || '' %>"
                          data-microchip="<%= c.microchip || '' %>"
                          data-breed="<%= c.breed || '' %>"
                        >
                          <%= c.name %>
                          <% if (c.pedigreeNumber) { %> - <%= c.pedigreeNumber %> <% } %>
                        </option>
                      <% }); %>
                    <% } %>
                  </select>
                </div>

                <div class="field">
                  <label class="field-label">Uso para reprodu√ß√£o</label>
                  <select name="breedingStatus" required>
                    <option value="">Selecione...</option>
                    <option value="BREEDING">Breeding</option>
                    <option value="NOT_FOR_BREEDING">Not for Breeding</option>
                  </select>
                </div>
              </div>
            </div>

<!-- SE√á√ÉO: PROPRIET√ÅRIOS -->
<div class="section">
  <div class="section-title"><strong>Propriet√°rios</strong></div>

  <!-- LINHA 1 -->
  <div class="grid-3">

    <!-- ANTIGO PROPRIET√ÅRIO (SELETOR) -->
    <div class="field">
      <label class="field-label">Antigo propriet√°rio</label>
      <select
        id="oldOwnerType"
        name="oldOwnerType"
        onchange="toggleOwnerType()"
        required
      >
        <option value="ME">Eu mesmo</option>
        <option value="OTHER">Outro</option>
      </select>
    </div>

    <!-- NOVO PROPRIET√ÅRIO -->
    <div class="field">
      <label class="field-label">Novo propriet√°rio</label>
      <input
        id="newOwnerName"
        type="text"
        name="newOwnerName"
        placeholder="Nome do novo propriet√°rio"
        required
      />
    </div>

    <!-- TIPO DE MEMBRO (S√ì EU MESMO) -->
    <div class="field" id="memberBlock">
      <label class="field-label">Tipo de membro</label>
      <select
        id="memberType"
        name="memberType"
        onchange="toggleExtra()"
      >
        <option value="">Selecione...</option>
        <option value="FIFE">Membro FIFe (FFB)</option>
        <option value="NAO_FIFE">Membro N√£o FIFe (FFB)</option>
      </select>
    </div>
  </div>

  <!-- LINHA 2 ‚Äî NOME DO ANTIGO PROPRIET√ÅRIO (S√ì QUANDO OUTRO) -->
  <div class="grid-1" id="oldOwnerNameBlock" style="margin-top:12px; display:none;">
    <div class="field">
      <label class="field-label">Nome do antigo propriet√°rio</label>
      <input
        type="text"
        name="oldOwnerName"
        placeholder="Nome do antigo propriet√°rio"
      />
    </div>
  </div>

  <!-- UPLOAD DOCUMENTO (S√ì QUANDO OUTRO) -->
<div
  class="grid-1"
  id="authorizationFileBlock"
  style="margin-top:12px; display:none;"
>
  <div class="field">
    <label class="field-label">
      Documento do antigo propriet√°rio
    </label>
    <input
      type="file"
      name="authorizationFile"
      accept=".pdf,.jpg,.jpeg,.png"
    />
    <div class="field-hint" style="color:#b71c1c;">
  Envie autoriza√ß√£o ou documento comprobat√≥rio do antigo propriet√°rio
  (Exemplo para download na p√°gina Servi√ßos).
</div>
  </div>
</div>


              <!-- CAMPOS EXTRAS PARA N√ÉO FIFE -->
              <div id="extraFields" style="display:none; margin-top:14px;">

                <div class="grid-2">
                  <div class="field">
                    <label class="field-label">Endere√ßo</label>
                    <input type="text" name="address" />
                  </div>

                  <div class="field">
                    <label class="field-label">Bairro</label>
                    <input type="text" name="district" />
                  </div>
                </div>

                <div class="grid-3" style="margin-top:10px;">
                  <div class="field">
                    <label class="field-label">Cidade</label>
                    <input type="text" name="city" />
                  </div>

                  <div class="field">
                    <label class="field-label">Estado</label>
                    <input type="text" name="state" />
                  </div>

                  <div class="field">
                    <label class="field-label">CEP</label>
                    <input type="text" name="cep" />
                  </div>
                </div>

                <div class="grid-2" style="margin-top:10px;">
                  <div class="field">
                    <label class="field-label">E-mail</label>
                    <input type="email" name="email" />
                  </div>

                  <div class="field">
                    <label class="field-label">Telefone</label>
                    <input type="text" name="phone" />
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- RODAP√â DO FORMUL√ÅRIO -->
          <div class="footer">
            <a href="/services" class="btn">Cancelar</a>
           
            <button type="submit" class="btn btn-primary submit-btn">
  <span class="submit-text">Salvar/Enviar</span>
  <span class="spinner" style="display:none; margin-left:8px;"></span>
</button>

          </div>
        </form>
      </main>
    </div>

    <!-- SCRIPT DO TOGGLE -->
<script>
function toggleExtra() {
  const memberTypeEl = document.getElementById("memberType");
  const oldOwnerTypeEl = document.getElementById("oldOwnerType");
  const extraFields = document.getElementById("extraFields");

  if (!memberTypeEl || !oldOwnerTypeEl || !extraFields) return;

  const memberType = memberTypeEl.value;
  const oldOwnerType = oldOwnerTypeEl.value;

  if (oldOwnerType === "ME" && memberType === "NAO_FIFE") {
    extraFields.style.display = "block";
  } else {
    extraFields.style.display = "none";
  }
}


function toggleOwnerType() {
  const oldOwnerTypeEl = document.getElementById("oldOwnerType");
if (!oldOwnerTypeEl) return;
const type = oldOwnerTypeEl.value;


  const newOwner = document.getElementById("newOwnerName");
  const memberBlock = document.getElementById("memberBlock");
  const oldOwnerNameBlock = document.getElementById("oldOwnerNameBlock");
  const authorizationFileBlock = document.getElementById("authorizationFileBlock");
  const extraFields = document.getElementById("extraFields");

  if (!type) return;

  if (type === "ME") {
    // üîπ EU MESMO
    newOwner.value = "";
    newOwner.readOnly = false;

    memberBlock.style.display = "block";
    oldOwnerNameBlock.style.display = "none";
    authorizationFileBlock.style.display = "none";
    extraFields.style.display = "none";

  } else {
    // üîπ OUTRO
    newOwner.value = "<%= user.name %>";
    newOwner.readOnly = true;

    memberBlock.style.display = "none";
    oldOwnerNameBlock.style.display = "block";
    const authInput = document.querySelector(
  'input[name="authorizationFile"]'
);

if (type === "OTHER") {
  authorizationFileBlock.style.display = "block";
  authInput.required = true;
} else {
  authorizationFileBlock.style.display = "none";
  authInput.required = false;
  authInput.value = "";
}

    console.log("MOSTRANDO UPLOAD");
    extraFields.style.display = "none";
  }
}

  // ‚úÖ ESTA LINHA TEM QUE EXISTIR ASSIM
  document.addEventListener("DOMContentLoaded", () => {
  toggleOwnerType();
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("form").forEach((form) => {
      form.addEventListener("submit", () => {
        const submitBtn = form.querySelector("button[type='submit']");
        if (!submitBtn) return;

        const textEl = submitBtn.querySelector(".submit-text");
        const spinnerEl = submitBtn.querySelector(".spinner");

        // bloqueia bot√£o
        submitBtn.disabled = true;

        // altera texto
        if (textEl) {
          textEl.dataset.original = textEl.textContent;
          textEl.textContent = "Processando...";
        }

        // mostra spinner
        if (spinnerEl) {
          spinnerEl.style.display = "inline-block";
        }
      });
    });
  });
</script>


  </body>
</html>
